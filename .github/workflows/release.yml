name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Publish dupes-core
        run: cargo publish -p dupes-core
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for dupes-core on crates.io
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == "dupes-core") | .version')"
          echo "Waiting for dupes-core ${VERSION}..."
          for attempt in $(seq 1 10); do
            if curl -fsS "https://crates.io/api/v1/crates/dupes-core/${VERSION}" > /dev/null; then
              echo "dupes-core ${VERSION} is available."
              exit 0
            fi
            echo "Attempt ${attempt}/10: not yet available. Sleeping 15s..."
            sleep 15
          done
          echo "Timed out waiting for dupes-core ${VERSION}."
          exit 1

      - name: Publish dupes-rust
        run: cargo publish -p dupes-rust
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for dupes-rust on crates.io
        shell: bash
        run: |
          set -euo pipefail
          VERSION="$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == "dupes-rust") | .version')"
          echo "Waiting for dupes-rust ${VERSION}..."
          for attempt in $(seq 1 10); do
            if curl -fsS "https://crates.io/api/v1/crates/dupes-rust/${VERSION}" > /dev/null; then
              echo "dupes-rust ${VERSION} is available."
              exit 0
            fi
            echo "Attempt ${attempt}/10: not yet available. Sleeping 15s..."
            sleep 15
          done
          echo "Timed out waiting for dupes-rust ${VERSION}."
          exit 1

      - name: Publish cargo-dupes
        run: cargo publish -p cargo-dupes
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Publish code-dupes
        run: cargo publish -p code-dupes
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
